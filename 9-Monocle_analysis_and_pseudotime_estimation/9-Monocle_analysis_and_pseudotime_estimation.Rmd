---
subtitle: "8-Monocle analysis and pseudotime estimation"
bibliography: bib.bib
link-citations: yes
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output: 
  pdf_document:
    pandoc_args: 
      - '../common.yaml'
      - --listings
    includes: 
      in_header: '../preamble.tex'
    toc: true
    number_sections: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: tibble
---

```{r include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

\newpage

# Description

To evaluate trajectory-based DE analysis during IM development in IM-DTR mice, Ly6C+ cMo, transit cells, CD206- and CD206+ IM were subjected to Monocle [@Trapnell2014] analysis. The Monocle CDS object was built with counts and metadata from Seurat object and converted using SeuratWrappers package. Cells were clustered with cluster_cells function using calculated UMAP coordination and resolution of 0.51E-3. The trajectories along pseudotime were built using learn_graph and order_cells functions. The DE genes across trajectory were calculated using Moranâ€™s I test (graph_test function) and only the genes with q_value of 0 and Morans_I over 0.25 were kept as significant DE genes and subjected to further analyses. 

Here we build up Monocle object with data and metadata in Seurat project. 

# Load packages and data

```{r}
suppressMessages(library(Seurat))
suppressMessages(library(SeuratWrappers))
suppressMessages(library(monocle3))
```

Load data
```{r}
IM_DTR3 <- readRDS(file = "../8-SCENIC_analysis/only_IM_differentiation.with_SCENIC.seuratObject.Rds")
```

## Re-calculate UMAP

As a subset of population was used in the following analysis, we re calculated UMAP. 

```{r}
IM_DTR3 <- RunUMAP(IM_DTR3, dims = 1:8, n.components = 3L)
DimPlot(IM_DTR3, group.by = "cell.type2")
```


# Create Monocle object 

```{r include=FALSE}
IM_DTR3.cds <- readRDS("./only_IM_differentiation.with_Pseudotime.cds.Rds")
```

```{r}
DefaultAssay(IM_DTR3) <- "RNA"
```

```{r eval=FALSE}
IM_DTR3.cds <- as.cell_data_set(IM_DTR3)

IM_DTR3.cds <- estimate_size_factors(IM_DTR3.cds)

IM_DTR3.cds@rowRanges@elementMetadata@listData[["gene_short_name"]] <- rownames(IM_DTR3[["RNA"]])
```

## Clusterting, pseudotime estimation and trajectory analysis

> Since cluster_cells uses randam seed, the results could be slightly different. To recapitulate the exact results showed in report, please download the cds object: `only_IM_differentiation.with_Pseudotime.cds`

```{r eval=FALSE}
IM_DTR3.cds <- cluster_cells(cds = IM_DTR3.cds, reduction_method = "UMAP", resolution=0.51e-3, random_seed = 41)  
IM_DTR3.cds <- learn_graph(IM_DTR3.cds, use_partition = FALSE)
```

```{r}
plot_cells(IM_DTR3.cds)
```

```{r eval=FALSE}
all_cells <- choose_cells(IM_DTR3.cds, return_list = TRUE)
not_mono <- choose_graph_segments(IM_DTR3.cds, return_list = TRUE)
root <- setdiff(all_cells, not_mono$cells)
```

```{r eval=FALSE}
IM_DTR3.cds <- order_cells(IM_DTR3.cds, reduction_method = "UMAP", root_cells = root)
```

## Plot pseudotime across subsets 

Plot with relaculated UMAP and cell types:

```{r message=FALSE}
library(ggplot2)
plot_cells(
  cds = IM_DTR3.cds,
  color_cells_by = "cell.type2",
  show_trajectory_graph = FALSE
)
```
Pseudotime and 

```{r message=FALSE}
plot_cells(
  cds = IM_DTR3.cds,
  color_cells_by = "pseudotime",
  show_trajectory_graph = FALSE
)& scale_color_viridis_c()
```

To visualize in 3D plot: 

```{r eval=FALSE}
library(plotly)
p1 <- plot_cells_3d(IM_DTR3.cds, color_cells_by="pseudotime", show_trajectory_graph = TRUE)

# p1
# plot will not show in rendered PDF. 
```

## 3D Plots with trajectories across cell types

```{r eval=FALSE}
pal2 <- c(`Classical_Mono`="#A6CEE3", 
          `MHCII_IM`="#B2DF8A",
          `CD206_IM`="#33A02C", 
          `Transit` = "#E31A1C")

p2 <- plot_cells_3d(IM_DTR3.cds, color_cells_by="cell.type2", show_trajectory_graph = TRUE, color_palette = pal2, alpha = 0.6)

# p2
# plot will not show in rendered PDF. 
```



```{r eval=FALSE}
saveRDS(IM_DTR3.cds, file = "./only_IM_differentiation.with_Pseudotime.cds.Rds")
```

Add pseodotime to seurat object
```{r}
IM_DTR3 <- AddMetaData(object = IM_DTR3, metadata = IM_DTR3.cds@principal_graph_aux@listData$UMAP$pseudotime, col.name = "pseudotime")
```

Save seurat object
```{r eval=FALSE}
saveRDS(IM_DTR3, file = "./only_IM_differentiation.with_SCENIC.with_Pseudotime.seuratObject.Rds")
```


In the next step, we will only analysis the IM differentiation. 
Susbsetting differentiating cells

```{r eval=FALSE}
# Choose the nodes from beginning of Transit cells to both CD206+ and CD206- IMs. 

Mono_to_IM <- choose_graph_segments(IM_DTR3.cds, return_list = TRUE)
Mono_to_IM.cds <- IM_DTR3.cds[,IM_DTR3.cds@colData@rownames %in% Mono_to_IM$cells]
```

```{r eval=FALSE}
saveRDS(Mono_to_IM.cds, file = "Mono_to_IM.cds")
```


# Session information 

R sesssion: 

```{r}
sessionInfo()
```


# References








