---
subtitle: "11-Cell cycling in transit cells"
bibliography: bib.bib
link-citations: yes
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output: 
  #html_document
  pdf_document:
    pandoc_args:
      - '../common.yaml'
      - --listings
    includes:
      in_header: '../preamble.tex'
    toc: true
    number_sections: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: tibble
---

```{r include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

\newpage

# Description

In the DT treatment time-course analysis, we found transit population had up-DE genes of cell cycle. Here we focus on the cell cycle of this transit populaiton. The cell cycle score 

The GO enrichment analysis was made using clusterProfiler package [@Yu2012]. 

# Prepare data

```{r}
suppressMessages(
  {
    library(Seurat)
    library(dplyr)
    library(RColorBrewer)
    library(clusterProfiler)
    library(ggplot2)
    library(monocle3)
    }
)

so <- readRDS("../8-SCENIC_analysis/only_IM_differentiation.with_SCENIC.seuratObject.Rds")
```

## Subset the cMo population with only the differentiating cells

```{r message=FALSE}
# here's the cells that were used for monocyte-IM differentiation analysis: 
cds <- readRDS("../9-Monocle_analysis_and_pseudotime_estimation/Mono_to_IM.cds")

# subset with the cell names
so <- subset(so, cells = colnames(cds))

# check cell number
ncol(so) == ncol(cds)
```


# DE genes in transit cells

```{r fig.height=8, fig.width=6}
pal <- c("#A6CEE3", "#B2DF8A", "#33A02C", "#E31A1C")
all_cluster.markers <- FindAllMarkers(so, verbose = FALSE)
top20 <- all_cluster.markers %>% group_by(cluster) %>% top_n(n = 20, wt = avg_log2FC)
DoHeatmap(so, features = top20$gene, group.colors = pal) + NoLegend()
```
# GO analysis of DE genes of transit cells

```{r}
source("../R/entrez2symbol.R")
source("../R/replaceEntrezID.R")

de.transit <- all_cluster.markers[which(all_cluster.markers$cluster=="Transit" &
                                          all_cluster.markers$p_val_adj < 0.01), ]
# write.csv(de.transit, file = "./DE-Genes_in_Transit_cells.csv", quote = FALSE)
```

```{r}
suppressMessages({
  de_entrez <- bitr( geneID = de.transit$gene, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Mm.eg.db", drop = TRUE ) $ ENTREZID
})

```

```{r}
suppressMessages({
result.enrichGO <- enrichGO(de_entrez, OrgDb = "org.Mm.eg.db", ont = "BP")
result.enrichGO <- replaceEntrezID(result.enrichGO, organism = "mmu")
})
# write.csv(result.enrichGO@result, file = "./enrichGO_DE_genes_transit_cells.csv")
result.enrichGO@result
```

# Cell-cycle score in IM differentiation

```{r fig.height=4, fig.width=5}
VlnPlot(so, features = "G2M.Score", cols = pal, pt.size = 0) + ggtitle("")
```

```{r eval=FALSE}
ggsave(filename = "../Figures/VlnPlot_G2MScore_in_IM_differentiation.pdf", 
       width = 5, height = 4)
```

# Show cell-cycle score in UMAP plot precalculated in Monocle

UMAP coordination was calculated and stored in CDS object. 
```{r}

```


```{r fig.height=4, fig.width=6}
so[["UMAP2"]] <- CreateDimReducObject(embeddings = cds@int_colData@listData$reducedDims$UMAP, 
                                      key = "UMAP_", assay = DefaultAssay(so))
DimPlot(so, cols = pal, reduction = "UMAP2")
```
```{r}
ggsave(filename = "../Figures/UMAPplot_IM_diff_PC1_2.pdf", 
       width = 6, height = 4)
```


```{r fig.height=4, fig.width=5}
FeaturePlot(so, features = "G2M.Score", reduction = "UMAP2",
            cols = c("lightgrey", "red"), 
            min.cutoff = 0.)
```

```{r eval=FALSE}
ggsave(filename = "../Figures/FeaturePlot_G2M_in_IM_diff_PC1_2.pdf", 
       width = 5, height = 4)
```


# Session information 

R sesssion: 

```{r}
sessionInfo()
```


# References



